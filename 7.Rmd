---
title: "STOR 665 HW 7"
author: "Brian N. White"
date: "4/23/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(MEMSS)
library(lme4)
library(lattice)
```

### Problem 7

### (a)

Explain the data briefly.
```{r load data, examine structure}
#load data
ergoStool <- ergoStool

#examine the data structure
str(ergoStool)
```
```{r summary}
#data summary
summary(ergoStool)
```
Inspection of the contingency table below reveals that the factors 'Type' and 'Subject' are completely crossed (i.e. there is at least one observation for each combination of factor levels). Further, this is an unreplicated design.
```{r}
xtabs(~Type + Subject, ergoStool)
```
### (b)

```{r}
#determine the average effort for each level of the factor Subject
ergoStool %>%
  group_by(Subject) %>%
  summarize(avg_effort=mean(effort)) -> avg_effort_df

ergoStool %>% 
  mutate(avg_effort=rep(avg_effort_df$avg_effort, each=4, times=1)) %>%
  mutate(Subject=fct_reorder(Subject, avg_effort)) %>%
  ggplot(aes(x=Subject, y=effort, shape=Type, color=Type)) +
  geom_point() +
  geom_line(aes(x=Subject, y=effort, group=Type, color=Type, linetype=Type))

```

### (c)

A linear mixed model with random effects for Type and Subject is fit below. The standard deviations for the estimates corresponding to Type, Subject and residual variability are 1.332, 1.695, and 1.100, as discerned from the output below.
```{r}
#fit a model with random effects for Type and Subject via REML
summary(lmm_ergo <- lmer(effort ~ 1 + (1|Type) + (1|Subject), ergoStool))
```
### (d)

The model from part (c) is refit using maximum likelihood estimation. The standard deviations for the estimates corresponding to Type, Subject and residual variability are now 1.305, 1.505, and 1.101. 
```{r}
summary(lmm_ergo2 <- update(lmm_ergo, REML=FALSE))
```
### (e)

In the code-chunk below, the 95% prediction intervals corresponding to the random effects of the model from part (d) (i.e. the model fit via MLE) are generated. Based upon this plot, it is clear that stool type 1 (i.e. T1) outperforms the other types w.r.t. effort minimization.
```{r}
## Substitute the name of your fitted model for fm in the call to ranef)
dotplot(ranef(lmm_ergo2, which = "Type", postVar = TRUE), aspect = 0.2, strip = FALSE)
```

### (f)

The significance of the random effect Type is assessed by comparing the model fit in Part (d) with a reduced model with only Subject as the random effect. Inspection of the anova output indicates a p-value of ~0. Thus, we fail to reject the null hypothesis $H_{0}:\sigma_{2}=0$.
```{r}
summary(lmm_ergo3 <- lmer(effort ~ 1 + (1|Subject), ergoStool, REML=FALSE))
anova(lmm_ergo3, lmm_ergo2)
```

### (g)

Since we are interested in making inference about four stool types, a more reasonable model
is to treat Type as fix effects and Subject as the random effect. Fit this mixed effect model
using maximum likelihood. Calculate the fixed-effects predictors for the four different stool types. Compare the results with that in Part (e).

```{r}

```

